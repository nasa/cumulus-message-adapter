from copy import deepcopy
from jsonpath_ng import parse
from typing import Dict, Any


def assign_json_path_value(
    source_message: Dict[str, Any],
    jspath: str,
    value: Any
) -> Dict[str, Any]:
    """
    * Assign (update or insert) a value to message based on jsonpath.
    * Create the keys if jspath doesn't already exist in the message.
    * In this case, we support 'simple' jsonpath
    * like $.path1.path2.path3....
    * @param {dict} source_message The message to be updated
    * @param {string} jspath JSON path string
    * @param {*} value Value to update to
    * @return {*} updated message
    """
    message = deepcopy(source_message)
    if not parse(jspath).find(message):
        paths = jspath.lstrip('$.').split('.')
        current_item = message
        key_not_found = False
        for path in paths:
            if key_not_found or path not in current_item:
                key_not_found = True
                new_path_dict = {}
                # Add missing key to existing dict
                current_item[path] = new_path_dict
                # Set current item to newly created dict
                current_item = new_path_dict
            else:
                current_item = current_item[path]
    parse(jspath).update(message, value)
    return message
